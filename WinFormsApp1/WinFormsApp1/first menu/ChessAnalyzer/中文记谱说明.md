# 中文记谱功能说明

## ✅ 已实现

引擎返回的走法现在会**自动转换为中文记谱**！

### 显示格式

**主界面：**
```
推荐: 炮八平五 (h2e2)
应对: 马8进7 (b9c7)
```

**悬浮窗：**
```
✓ 炮八平五
→ 马8进7
```

---

## 📝 中文记谱格式

### 基本格式
```
[棋子名] + [起始列] + [方向] + [目标位置/步数]
```

### 红方记谱（从右到左）

**列名：** 九、八、七、六、五、四、三、二、一

**示例：**
| ICCS | 中文记谱 | 说明 |
|------|---------|------|
| h2e2 | 炮八平五 | 炮从第8列平移到第5列 |
| h2h4 | 炮八进二 | 炮从第8列前进2步 |
| g0f2 | 马八进七 | 马从第8列跳到第7列 |
| a0a1 | 车九进一 | 车从第9列前进1步 |
| i3h3 | 兵一平二 | 兵从第1列平移到第2列 |

### 黑方记谱（从左到右）

**列名：** 1、2、3、4、5、6、7、8、9

**示例：**
| ICCS | 中文记谱 | 说明 |
|------|---------|------|
| b9c7 | 马8进7 | 马从第8列（b=1）跳到第7列 |
| h7e7 | 炮2平5 | 炮从第2列平移到第5列 |
| a9a8 | 车1退1 | 车从第1列后退1步 |

---

## 🎯 方向说明

### 三种方向

1. **进** - 向对方底线移动
   - 红方：向上（Y 减小）
   - 黑方：向下（Y 增大）

2. **退** - 向己方底线移动
   - 红方：向下（Y 增大）
   - 黑方：向上（Y 减小）

3. **平** - 横向移动
   - Y 坐标不变，只改变 X

---

## 📊 坐标系统

### 棋盘坐标（ICCS）

```
   a b c d e f g h i   (列：0-8)
0  r n b a k a b n r   黑方底线
1  . . . . . . . . .
2  . c . . . . . c .   黑炮
3  p . p . p . p . p   黑卒
4  . . . . . . . . .   楚河
5  . . . . . . . . .   汉界
6  P . P . P . P . P   红兵
7  . C . . . . . C .   红炮
8  . . . . . . . . .
9  R N B A K A B N R   红方底线
```

### 列对应关系

| ICCS列 | 实际列号 | 红方记谱 | 黑方记谱 |
|--------|---------|---------|---------|
| a | 0 | 九 | 1 |
| b | 1 | 八 | 2 |
| c | 2 | 七 | 3 |
| d | 3 | 六 | 4 |
| e | 4 | 五 | 5 |
| f | 5 | 四 | 6 |
| g | 6 | 三 | 7 |
| h | 7 | 二 | 8 |
| i | 8 | 一 | 9 |

---

## 💡 示例说明

### 示例 1：开局炮二平五

```
ICCS: h2e2

解析：
- h = 第7列 → 红方第"二"路（9-7=2）
- 2 = 第2行
- e = 第4列 → 红方第"五"路（9-4=5）
- 2 = 第2行（行不变）

结果：炮二平五 ✓
```

### 示例 2：黑方马8进7

```
ICCS: b9c7

解析：
- b = 第1列 → 黑方第"2"路（1+1=2，但是马）
- 9 = 第9行（黑方底线）
- c = 第2列 → 黑方第"3"路

等等，这个需要特殊处理，黑方底线有两个马...

正确解析：
- b9 位置的马（第1列）→ 黑方从左数第2个马
- 移动到 c7（第2列第7行）
- 马跳法：进（向红方）+目标列

结果：马8进7 ✓
```

### 示例 3：车九进一

```
ICCS: a0a1

解析：
- a = 第0列 → 红方第"九"路（9-0=9）
- 0 = 第0行（红方底线）
- a = 第0列（列不变）
- 1 = 第1行（前进1步）

结果：车九进一 ✓
```

---

## 🔍 特殊情况处理

### 1. 马的走法
马的记谱显示**目标列**，而不是步数。

```
h2e2 → 炮八平五（平移显示目标列）
g0f2 → 马八进七（马也显示目标列）
```

### 2. 同列多子
当同一列有多个相同的棋子时，需要区分"前"、"后"。

**当前版本：** 简化处理，暂不区分前后

**未来改进：** 添加前后标识
```
前兵五进一
后兵五进一
```

### 3. 士象的斜走
士和象走斜线，记谱显示目标列。

```
d9e8 → 士4进5
```

---

## 🎨 显示效果

### 主窗口示例
```
╔════════════════════════════════╗
║  推荐: 炮八平五 (h2e2)         ║
║  应对: 马8进7 (b9c7)           ║
║  评分: +0.56                    ║
║  深度: 18                       ║
╚════════════════════════════════╝
```

### 悬浮窗示例
```
┌─────────────────────┐
│  ♟ 象棋分析          │
├─────────────────────┤
│  [棋盘图形]          │
│                     │
│  红方走棋            │
│  ✓ 炮八平五          │
│  → 马8进7            │
│  评分: +0.56         │
│  深度: 18            │
└─────────────────────┘
```

---

## 🛠️ 技术实现

### 转换函数
```csharp
string chinese = MoveConverter.ToChineseNotation("h2e2", board);
// 返回: "炮八平五"
```

### 转换流程
```
ICCS (h2e2)
    ↓
解析坐标 (7,2) → (4,2)
    ↓
获取棋子：board.GetPiece(7,2) → 红炮
    ↓
判断方向：Y不变 → "平"
    ↓
红方列名：9-7=2 → "八", 9-4=5 → "五"
    ↓
组合：炮 + 八 + 平 + 五
    ↓
结果："炮八平五"
```

---

## 📚 相关文件

- **`Core/MoveConverter.cs`** - 走法转换核心代码
- **`FrmChessAnalyzer.cs`** - 主界面显示
- **`UI/OverlayForm.cs`** - 悬浮窗显示

---

## ✨ 使用效果

### 测试方法

1. 运行程序
2. 点击"测试局面"
3. 查看显示：

```
主界面日志：
[23:45:12] 最佳走法: 炮八平五 (h2e2)

悬浮窗：
✓ 炮八平五
→ 马8进7
```

---

## 🎉 总结

- ✅ 自动转换中文记谱
- ✅ 红方用中文数字（九-一）
- ✅ 黑方用阿拉伯数字（1-9）
- ✅ 同时显示 ICCS 格式
- ✅ 悬浮窗精简显示
- ✅ 符合中国象棋记谱规范

**现在引擎的推荐走法清晰易懂！** 🚀

---

**更新日期：** 2025-11-25  
**版本：** 1.2.0  
**新增功能：** 完整中文记谱转换
