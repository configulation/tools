# 🎯 识别测试功能使用说明

## 改进内容

### 1. **新增"识别测试"按钮** ✅
- 位置：手动测试面板，最右侧
- 颜色：青绿色（醒目）
- 功能：**只识别显示，不调用引擎**

### 2. **改进识别算法** ✅
- 使用 **HSV 颜色空间**（比 RGB 更准确）
- 根据棋子**初始位置推测类型**
- 详细的**调试信息输出**

### 3. **事件处理在 Designer.cs** ✅
- 方便图形化调试
- 符合 WinForms 设计规范

---

## 🚀 快速使用

### 步骤 1：选择棋盘区域
1. 打开象棋软件（如天天象棋）
2. 点击 **"选择棋盘区域"**
3. 拖动框选棋盘
4. 松开鼠标完成选择

### 步骤 2：识别测试
1. 点击 **"识别测试"** 按钮（青绿色）
2. 程序自动：
   - 截图
   - 识别棋子
   - 显示在悬浮窗
   - 输出详细日志

### 步骤 3：查看结果
- **悬浮窗**：显示识别的棋盘（图形化）
- **运行日志**：显示识别详情和调试信息

---

## 📊 识别原理

### 网格划分
```
将截图均匀分成 9列 x 10行
每个格子取中心 30% 区域分析
避开边界线，减少干扰
```

### 颜色检测
```
1. 转换到 HSV 颜色空间
2. 分析色相（Hue）、饱和度（Saturation）、明度（Value）

红色棋子：
- 饱和度 > 50
- 色相 < 10 或 > 170（红色范围）
- 或 R 值明显高于 G、B

黑色棋子：
- 明度 < 100
- 饱和度 < 100
```

### 棋子类型推测
```
根据位置推测类型：

红方（下方）：
- 底线（第9行）：帅、仕、相、马、车
- 第7行：炮
- 第6行：兵

黑方（上方）：
- 顶线（第0行）：将、士、象、马、车
- 第2行：炮
- 第3行：卒
```

---

## 🔍 调试信息解读

### 日志格式
```
[列,行] V:25.3 RGB:(180,45,32) HSV:(5,178,180) => 红
```

**含义：**
- `[列,行]`：格子位置（0-8, 0-9）
- `V:25.3`：颜色变化程度（>20 表示有棋子）
- `RGB`：红绿蓝值
- `HSV`：色相、饱和度、明度
- `=> 红/黑/空`：判断结果

### 示例分析
```
[4,9] V:32.5 RGB:(185,50,35) HSV:(6,175,185) => 红
```
- 位置 [4,9] = 第4列第9行 = 底线中央
- V=32.5 > 20 → 有棋子
- RGB: R(185) >> G(50), B(35) → 红色
- HSV: Hue=6 (红色), Saturation=175 (高饱和度)
- 结论：红方帅（底线中央）

---

## ⚠️ 常见问题

### Q1: 识别结果全是空格

**原因：** 
- 选择区域不正确
- 棋盘背景和棋子颜色差异小

**解决：**
1. 重新选择区域，确保框选完整棋盘
2. 查看日志中的 RGB 值，调整颜色阈值
3. 尝试不同的棋盘皮肤

### Q2: 红黑棋子识别反了

**原因：** 颜色判断阈值不适合当前棋盘

**解决：**
1. 查看日志中的 HSV 值
2. 在 `ImprovedRecognizer.cs` 中调整阈值
3. 例如修改：
```csharp
// 红色检测
if (saturation > 50 && (hue < 10 || hue > 170))
// 调整为
if (saturation > 30 && (hue < 15 || hue > 165))
```

### Q3: 棋子类型不准确

**原因：** 
- 棋子已经移动，不在初始位置
- 推测逻辑只适用于开局

**当前版本限制：**
- 棋子类型推测基于**位置**
- 适用于**开局或中局早期**
- 移动后的棋子可能识别为兵/卒

**未来改进：**
- 添加棋子图片模板匹配
- OCR 识别棋子汉字
- 深度学习模型

### Q4: 识别速度慢

**优化建议：**
1. 减小选择区域（只框棋盘，不要太大）
2. 关闭其他占用 CPU 的程序
3. 确保安装了 OpenCvSharp4

---

## 🎨 界面说明

### 主界面按钮
| 按钮 | 位置 | 功能 |
|------|------|------|
| **选择棋盘区域** | 左上 | 框选屏幕区域 |
| **开始分析** | 左上 | 实时分析（含引擎） |
| **分析FEN** | 中间 | 手动输入 FEN 分析 |
| **测试局面** | 中间 | 加载标准开局 |
| **显示悬浮窗** | 中间 | 显示/隐藏悬浮窗 |
| **识别测试** | 右侧（青绿色） | 只识别，不分析 ⭐ |

### 使用流程对比

**识别测试（调试用）**
```
选择区域 → 识别测试 → 查看悬浮窗 → 查看日志
                                        ↓
                               调整阈值/重新选区
```

**实时分析（正式用）**
```
选择区域 → 开始分析 → 自动识别 + 引擎分析 → 显示推荐走法
```

---

## 💡 调试技巧

### 1. 逐步验证
```
第一步：点击"选择棋盘区域" → 确认框选正确
第二步：点击"识别测试" → 查看悬浮窗显示
第三步：查看日志 → 分析 RGB/HSV 值
第四步：调整阈值 → 重新测试
```

### 2. 对比测试
```
用不同棋盘皮肤测试：
- 天天象棋
- 弈客象棋
- 象棋旋风

记录每种皮肤的典型 RGB/HSV 值
```

### 3. 保存调试信息
```
在日志面板中：
1. 复制完整日志
2. 保存到文本文件
3. 分析颜色分布规律
4. 调整识别算法
```

---

## 🔧 自定义调整

### 修改颜色阈值

打开文件：`Recognition/ImprovedRecognizer.cs`

找到 `AnalyzeCell` 方法：

```csharp
// 空格判断
if (colorVariance < 20)  // ← 调整这个值

// 红色检测
if (saturation > 50 && (hue < 10 || hue > 170))  // ← 调整这些值

// 黑色检测
if (value < 100 && saturation < 100)  // ← 调整这些值
```

### 修改采样区域

找到 `RecognizeToBoard` 方法：

```csharp
// 提取格子中心的小区域
int sampleSize = (int)Math.Min(cellWidth * 0.3, cellHeight * 0.3);
                                         // ↑ 调整采样比例（0.1-0.5）
```

---

## 📈 后续改进计划

### 短期（已规划）
- [ ] 添加颜色阈值配置界面
- [ ] 支持多种棋盘皮肤预设
- [ ] 保存识别结果截图

### 中期（计划中）
- [ ] 棋子图片模板库
- [ ] 模板匹配算法
- [ ] OCR 文字识别

### 长期（研究中）
- [ ] 深度学习模型
- [ ] 自适应阈值调整
- [ ] 多线程并行识别

---

## 📞 反馈与改进

### 如何反馈问题
1. 截图保存识别结果
2. 复制运行日志
3. 说明使用的棋盘软件
4. 描述具体问题

### 提供调试信息
```
1. 截图：原始棋盘
2. 日志：完整识别详情
3. 环境：棋盘软件名称、版本
4. 现象：识别错误的具体位置
```

---

## 🎉 开始测试

**现在就试试吧！**

1. 打开象棋软件
2. 点击"选择棋盘区域"
3. 点击"识别测试"
4. 查看悬浮窗和日志

**祝测试顺利！** 🚀

---

**更新日期：** 2025-11-25  
**版本：** 1.1.0  
**新增功能：** 识别测试 + 改进算法 + 调试信息
