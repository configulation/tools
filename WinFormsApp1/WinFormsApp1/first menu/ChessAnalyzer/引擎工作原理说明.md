# Pikafish 引擎工作原理详解

## 一、引擎是做什么的？

Pikafish 是一个**象棋大脑**，它只会：
- ✅ 接收当前棋盘状态（FEN 格式）
- ✅ 思考并计算最佳走法
- ✅ 返回推荐走法和评分
- ❌ **不会**记住历史、不会识别图片、不会显示界面

## 二、走到第 30 步时引擎怎么帮你？

### 场景举例

```
你在下棋，已经走了 30 步：
第 1 步：炮二平五
第 2 步：马8进7
...
第 30 步：车1进1

现在你卡壳了，不知道怎么走 ← 这时候需要引擎帮忙
```

### 引擎需要什么信息？

引擎**不需要**前面 30 步的历史走法！

引擎**只需要**第 30 步走完后的棋盘状态（FEN）：

```
当前局面的 FEN：
r1ba1ab1r/4k4/2n1c1n2/p1p1p1p1p/6P2/9/P1P1P3P/1CN2C3/4A4/R1BAKAB1R w - - 0 31
                                                                         ↑
                                                                    轮到红方走(w)
```

### 完整流程

```
┌────────────────────────┐
│ 你已经走了 30 步         │
│ 棋盘上棋子是这样摆的      │
└────────┬───────────────┘
         ↓
  【如何告诉引擎当前局面？】
         ↓
  ┌─────────────────┐
  │ 方法1: 截图识别   │ ← 本项目实现的功能
  │ 方法2: 手动输入FEN │
  └─────────┬───────┘
            ↓
   【发送FEN给引擎】
position fen r1ba1ab1r/...  ← 告诉引擎当前局面
go depth 18                 ← 让引擎思考到深度18
            ↓
   【引擎思考 2-3 秒】
            ↓
   【引擎返回结果】
bestmove c3e3      ← 推荐：炮三平五
ponder h7e7        ← 预测对方：马7退5
score cp 125       ← 评分：红方优势 +1.25
```

## 三、引擎的输入输出格式

### 输入格式（你发给引擎）

```
position fen rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w - - 0 1
go depth 18
```

**解释：**
- `position fen ...` = 设置当前局面
- `go depth 18` = 开始计算，搜索深度 18

### 输出格式（引擎返回）

```
info depth 18 score cp 56 nodes 1234567 pv h2e2 h7e7 ...
bestmove h2e2 ponder h7e7
```

**解释：**
- `info` = 分析过程信息
  - `depth 18` = 当前搜索深度
  - `score cp 56` = 评分 +0.56（56 厘兵）
  - `nodes 1234567` = 搜索了 123 万个节点
  - `pv h2e2 h7e7` = 主要变化（预测的走法序列）
- `bestmove h2e2` = 最佳走法（ICCS 格式）
- `ponder h7e7` = 预测对方应对

**重点：引擎不返回新的 FEN，只返回走法！**

## 四、走法格式说明

### ICCS 格式（引擎使用）

格式：`[起点列][起点行][终点列][终点行]`

```
h2e2 的含义：
h = 第 7 列 (a=0, b=1, ..., h=7)
2 = 第 2 行
e = 第 4 列
2 = 第 2 行

意思：第7列第2行的棋子 → 移动到第4列第2行
```

### 常见走法示例

| ICCS 走法 | 中文记谱 | 说明 |
|-----------|---------|------|
| h2e2 | 炮八平五 | 炮横向移动 |
| b0c2 | 马二进三 | 马走日字 |
| a0a1 | 车一进一 | 车前进 |
| i9i8 | 车九退一 | 车后退 |

## 五、实际代码示例

### 示例 1：分析标准开局

```csharp
// 1. 标准开局局面
string startFEN = "rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w - - 0 1";

// 2. 发送给引擎
_engine.AnalyzePosition(startFEN, depth: 18);

// 3. 等待结果（通过事件接收）
void OnBestMoveReceived(object sender, BestMoveEventArgs e)
{
    // e.BestMove = "h2e2"  ← 推荐：炮二平五
    // e.PonderMove = "h7e7" ← 预测对方：炮8平5
}
```

### 示例 2：你走到第 30 步

```csharp
// 情况：你已经下了 30 步，不知道第 31 步怎么走

// 步骤 1：获取当前局面
// 方式A：截图识别（自动）
var screenshot = ScreenCapture.CaptureScreen(boardArea);
var result = recognizer.RecognizeToFEN(screenshot);
string currentFEN = result.FEN;

// 方式B：手动输入
string currentFEN = "r1ba1ab1r/4k4/.../... w - - 0 31";

// 步骤 2：发送给引擎
_engine.AnalyzePosition(currentFEN, depth: 18);

// 步骤 3：引擎返回推荐
// bestmove c3e3 ← 推荐你走 炮三平五
```

### 示例 3：连续分析多步

```csharp
// 场景：每次走完一步，都要引擎分析下一步

ChessBoard board = new ChessBoard();
board.LoadFromFEN(currentFEN);

// 第 31 步：引擎推荐 c3e3
_engine.AnalyzePosition(board.ToFEN(), 18);
// 收到：bestmove c3e3

// 执行走法（你需要自己更新棋盘）
ExecuteMove(board, "c3e3");

// 第 32 步：对方走棋后，再次分析
_engine.AnalyzePosition(board.ToFEN(), 18);
// 收到：bestmove ...
```

## 六、关键理解

### 1. 引擎是无状态的

```
引擎不记得：
❌ 前面走了什么
❌ 谁先手
❌ 是开局还是残局

引擎只看：
✅ 当前棋盘状态（FEN）
✅ 轮到谁走
```

### 2. 每次分析都是独立的

```
第 10 步分析 → 引擎思考 → 返回结果
第 20 步分析 → 引擎思考 → 返回结果（不记得第10步）
第 30 步分析 → 引擎思考 → 返回结果（不记得第10、20步）
```

### 3. FEN 包含所有必要信息

```
FEN 格式：
rnbakabnr/9/...  w  -  -  0  1
     ↓           ↓  ↓  ↓  ↓  ↓
   棋子位置    走棋方 其他规则信息
```

## 七、图像识别的作用

### 为什么需要图像识别？

```
问题：引擎只认 FEN，不认图片
      ↓
解决：用图像识别把棋盘截图转成 FEN
      ↓
流程：截图 → 识别 → FEN → 引擎 → 推荐走法
```

### 本项目的实现

```
1. 用户选择棋盘区域（框选）
2. 程序每 2 秒截图
3. OpenCV 识别棋子位置和颜色
4. 转换成 FEN 格式
5. 发送给 Pikafish 引擎
6. 显示推荐走法在悬浮窗
```

## 八、常见疑问解答

### Q1: 引擎会记住我的走法吗？

**答：不会。** 每次分析都是独立的，引擎不记录历史。

### Q2: 我需要把前面 30 步都告诉引擎吗？

**答：不需要。** 只需要第 30 步后的棋盘状态（FEN）。

### Q3: 引擎返回的是什么？

**答：走法（ICCS 格式），不是新的 FEN。**

### Q4: 如何得到新局面的 FEN？

**答：你需要自己根据走法更新棋盘，然后生成新 FEN。**

```csharp
// 当前 FEN
string fen1 = "rnbakabnr/.../...";

// 引擎推荐走法
string move = "h2e2";

// 执行走法（需要你实现）
ExecuteMove(board, move);

// 生成新 FEN
string fen2 = board.ToFEN();
```

### Q5: 为什么要用图像识别？

**答：因为引擎不能直接看屏幕，需要用图像识别把棋盘转成 FEN 告诉引擎。**

---

## 总结

```
象棋软件（你看到的棋盘）
         ↓ 截图
    图像识别器 ← 你需要实现
         ↓ FEN
    Pikafish 引擎 ← 本项目已集成
         ↓ 走法
    悬浮窗显示 ← 本项目已实现
```

**核心流程：** 棋盘 → 识别 → FEN → 引擎 → 推荐走法

**引擎的职责：** 只负责"思考"，不负责"看"和"显示"

**你的职责：** 让引擎"看到"棋盘（提供 FEN）

---

**创建时间：** 2025-11-25  
**适用版本：** Pikafish 2024.10.27+
