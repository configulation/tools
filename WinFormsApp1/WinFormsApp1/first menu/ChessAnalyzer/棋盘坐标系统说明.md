# 中国象棋棋盘坐标系统说明

## 📐 棋盘结构

### 基本概念
- **交叉点数量**: 9列 × 10行 = 90个交叉点
- **方格数量**: 8列 × 9行 = 72个方格
- **棋子位置**: 棋子的中心点位于交叉点上，**不是**方格中心

```
交叉点编号（列x行）:
     0   1   2   3   4   5   6   7   8  (列)
  ┌───┬───┬───┬───┬───┬───┬───┬───┬───┐
0 ●───●───●───●───●───●───●───●───●   
  │   │   │   │ \ │ / │   │   │   │
1 ●───●───●───●───●───●───●───●───●
  │   │   │   │ / │ \ │   │   │   │
2 ●───●───●───●───●───●───●───●───●
  │   │   │   │   │   │   │   │   │
3 ●───●───●───●───●───●───●───●───●
  │   │   │   │   │   │   │   │   │
4 ●───●───●───●───●───●───●───●───●
  ═════════ 楚河 · 汉界 ═════════
5 ●───●───●───●───●───●───●───●───●
  │   │   │   │   │   │   │   │   │
6 ●───●───●───●───●───●───●───●───●
  │   │   │   │   │   │   │   │   │
7 ●───●───●───●───●───●───●───●───●
  │   │   │   │ \ │ / │   │   │   │
8 ●───●───●───●───●───●───●───●───●
  │   │   │   │ / │ \ │   │   │   │
9 ●───●───●───●───●───●───●───●───●
  └───┴───┴───┴───┴───┴───┴───┴───┴───┘
(行)

● = 交叉点（棋子位置）
```

---

## 🖼️ 图片坐标映射

### 图片尺寸定义
假设输入图片尺寸为 `width × height` 像素。

### 方格尺寸计算
```csharp
// 棋盘有 8 个格子宽，9 个格子高
double cellWidth = width / 8.0;   // 每个格子的宽度
double cellHeight = height / 9.0; // 每个格子的高度
```

### 交叉点坐标计算
```csharp
// 第 col 列，第 row 行的交叉点坐标
int x = (int)(col * cellWidth);   // col: 0-8
int y = (int)(row * cellHeight);  // row: 0-9
```

**示例：**
- 第 0 列，第 0 行（左上角）: `(0, 0)`
- 第 4 列，第 0 行（中间上方）: `(width/2, 0)`
- 第 8 列，第 9 行（右下角）: `(width, height)`

---

## ✅ 正确理解

### ❌ 错误理解（方格中心）
```
棋子在方格中心 ❌
┌───────┬───────┐
│   ♜   │   ♞   │  ← 棋子在格子内部
├───────┼───────┤
│   ♟   │       │
└───────┴───────┘
```

### ✅ 正确理解（交叉点）
```
棋子在交叉点上 ✅
●───────●───────●
│   ♜   │   ♞   │  ← 棋子中心与交叉点重合
●───────●───────●
│   ♟   │       │
●───────●───────●
```

---

## 🔧 代码实现验证

### 1. 识别器（FeatureBasedRecognizer.cs）

```csharp
// 计算格子尺寸
double cellWidth = width / 8.0;   // ✅ 正确
double cellHeight = height / 9.0; // ✅ 正确

// 遍历所有交叉点
for (int row = 0; row < 10; row++)     // ✅ 10行交叉点
{
    for (int col = 0; col < 9; col++)  // ✅ 9列交叉点
    {
        // 计算交叉点坐标
        int centerX = (int)(col * cellWidth);   // ✅ 正确
        int centerY = (int)(row * cellHeight);  // ✅ 正确
        
        // 以交叉点为中心采样
        var piece = AnalyzePosition(image, col, row, cellWidth, cellHeight, debugInfo);
    }
}
```

### 2. 悬浮窗（OverlayForm.cs）

```csharp
// 绘制棋盘线
for (int i = 0; i < 10; i++)  // ✅ 10条横线
    g.DrawLine(pen, 5, 5 + i * 27, 299, 5 + i * 27);

for (int i = 0; i < 9; i++)   // ✅ 9条竖线
    g.DrawLine(pen, 5 + i * 33, 5, 5 + i * 33, ...);

// 放置棋子在交叉点
_pieceBoxes[x, y] = new PictureBox
{
    Location = new Point(5 + x * 33, 5 + y * 27)  // ✅ 交叉点坐标
};
```

---

## 📝 总结

| 概念 | 数值 | 说明 |
|------|------|------|
| 列数（交叉点） | 9 | 从 0 到 8 |
| 行数（交叉点） | 10 | 从 0 到 9 |
| 方格宽度 | `width / 8` | 8 个格子宽 |
| 方格高度 | `height / 9` | 9 个格子高 |
| 交叉点 x | `col × cellWidth` | col ∈ [0, 8] |
| 交叉点 y | `row × cellHeight` | row ∈ [0, 9] |

**关键点：棋子中心必须与交叉点重合，不能位于方格内部！**

---

## ⚠️ 常见问题

### Q1: 为什么识别不准？
**A**: 确保输入图片是**标准棋盘**：
- ✅ 完整的 9×10 交叉点
- ✅ 从左上角到右下角
- ❌ 不包含额外边框
- ❌ 不是裁剪过的局部图

### Q2: 悬浮窗显示位置不对？
**A**: 悬浮窗代码已正确实现，如果显示不对，请检查：
- 输入的 `ChessBoard` 数据是否正确
- 棋子坐标 `(col, row)` 是否在 `[0-8, 0-9]` 范围内

### Q3: 如何验证坐标正确性？
**A**: 
1. 检查左上角棋子（帅/将）应该在 `(4, 0)` 或 `(4, 9)`
2. 检查边界棋子（车）应该在 `(0, 0)`, `(8, 0)`, `(0, 9)`, `(8, 9)`
3. 使用日志输出查看识别到的棋子坐标

---

## 🎯 代码逻辑确认

✅ **当前所有代码的坐标计算都是正确的！**
✅ **棋子位置都在交叉点上，不在方格内部！**
✅ **符合中国象棋标准规则！**
