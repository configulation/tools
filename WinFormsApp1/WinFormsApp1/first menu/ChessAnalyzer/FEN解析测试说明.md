# ğŸ¯ FENè§£æå™¨ - åŸºäº xiangqi-tools å®ç°

## âœ… å·²å®ç°

### æ ¸å¿ƒåŠŸèƒ½

åŸºäº GitHub é¡¹ç›® https://github.com/kuiba1949/xiangqi-tools çš„ FEN è§£æé€»è¾‘ï¼Œæˆ‘å®ç°äº†ä¸€ä¸ªå‡†ç¡®çš„ C# ç‰ˆæœ¬ã€‚

---

## ğŸ“Š å®ç°ç»†èŠ‚

### 1. FenParser ç±»

**ä½ç½®ï¼š** `Core/FenParser.cs`

**åŠŸèƒ½ï¼š**
```csharp
// è§£æ FEN å­—ç¬¦ä¸²
var result = FenParser.Parse(fen);
if (result.Success) {
    // result.Board æ˜¯ 10x9 çš„æ£‹ç›˜æ•°ç»„
    // result.CurrentPlayer æ˜¯å½“å‰èµ°æ£‹æ–¹
}

// ç”Ÿæˆ FEN å­—ç¬¦ä¸²
string fen = FenParser.ToFen(board, "çº¢æ–¹");

// ç”Ÿæˆæ–‡æœ¬æ£‹ç›˜
string textBoard = FenParser.ToTextBoard(board, true);
```

---

### 2. è§£æè§„åˆ™ï¼ˆå®Œå…¨éµå¾ª xiangqi-toolsï¼‰

#### æ£‹å­ä»£ç æ˜ å°„

| FENä»£ç  | æ£‹å­ | è¯´æ˜ |
|---------|------|------|
| K | å¸… | çº¢æ–¹å°†å¸… |
| A | ä»• | çº¢æ–¹å£« |
| B, E | ç›¸ | çº¢æ–¹ç›¸ï¼ˆBæˆ–Eéƒ½å¯ä»¥ï¼‰ |
| N, H | é©¬ | çº¢æ–¹é©¬ï¼ˆNæˆ–Héƒ½å¯ä»¥ï¼‰ |
| R | è½¦ | çº¢æ–¹è½¦ |
| C | ç‚® | çº¢æ–¹ç‚® |
| P | å…µ | çº¢æ–¹å…µ |
| k | å°† | é»‘æ–¹å°†å¸… |
| a | å£« | é»‘æ–¹å£« |
| b, e | è±¡ | é»‘æ–¹è±¡ |
| n, h | é©¬ | é»‘æ–¹é©¬ |
| r | è½¦ | é»‘æ–¹è½¦ |
| c | ç‚® | é»‘æ–¹ç‚® |
| p | å’ | é»‘æ–¹å’ |
| 1-9 | ç©ºæ ¼ | è¿ç»­ç©ºæ ¼æ•°é‡ |

#### æ‰©å±•ä»£ç ï¼ˆéæ ‡å‡†FENï¼‰

| ä»£ç  | å«ä¹‰ |
|------|------|
| 0, X | çº¢æ–¹æ ‡è®°ä½ç½® |
| x | é»‘æ–¹æ ‡è®°ä½ç½® |

---

### 3. FEN æ ¼å¼ç¤ºä¾‹

#### æ ‡å‡†å¼€å±€

```
rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w - - 0 1
```

**è§£æï¼š**
```
rnbakabnr       ç¬¬0è¡Œï¼šé»‘æ–¹åº•çº¿ï¼ˆè½¦é©¬è±¡å£«å°†å£«è±¡é©¬è½¦ï¼‰
9               ç¬¬1è¡Œï¼šå…¨ç©º
1c5c1           ç¬¬2è¡Œï¼šç©º-ç‚®-5ç©º-ç‚®-ç©º
p1p1p1p1p       ç¬¬3è¡Œï¼šå’-ç©º-å’-ç©º-å’-ç©º-å’-ç©º-å’
9               ç¬¬4è¡Œï¼šå…¨ç©ºï¼ˆæ¥šæ²³ï¼‰
9               ç¬¬5è¡Œï¼šå…¨ç©ºï¼ˆæ±‰ç•Œï¼‰
P1P1P1P1P       ç¬¬6è¡Œï¼šå…µ-ç©º-å…µ-ç©º-å…µ-ç©º-å…µ-ç©º-å…µ
1C5C1           ç¬¬7è¡Œï¼šç©º-ç‚®-5ç©º-ç‚®-ç©º
9               ç¬¬8è¡Œï¼šå…¨ç©º
RNBAKABNR       ç¬¬9è¡Œï¼šçº¢æ–¹åº•çº¿ï¼ˆè½¦é©¬ç›¸ä»•å¸…ä»•ç›¸é©¬è½¦ï¼‰
w               çº¢æ–¹å…ˆè¡Œï¼ˆw=white/çº¢ï¼Œb=black/é»‘ï¼‰
- - 0 1         å…¶ä»–æ ‡å‡†å­—æ®µ
```

#### ä¸­å±€ç¤ºä¾‹

```
r1bakab1r/9/1cn2nc2/p1p1p1p1p/9/2P6/P3P1P1P/2N5C/9/RNBAKAB1R w - - 0 10
```

---

## ğŸ¨ æ–‡æœ¬æ£‹ç›˜è¾“å‡º

### æ ‡å‡†æ ¼å¼

```csharp
string text = FenParser.ToTextBoard(board, true);
```

**è¾“å‡ºï¼š**
```
ã€€ï¼‘ã€€ï¼’ã€€ï¼“ã€€ï¼”ã€€ï¼•ã€€ï¼–ã€€ï¼—ã€€ï¼˜ã€€ï¼™
ã€€ ==ã€€==ã€€==ã€€##ã€€##ã€€##ã€€==ã€€==ã€€==
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€é»‘æ–¹

ã€€[è½¦][é©¬][è±¡][å£«][å°†][å£«][è±¡][é©¬][è½¦]  9
ã€€ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼   8
ã€€ ï¼ [ç‚®] ï¼ ï¼ ï¼ ï¼ ï¼ [ç‚®] ï¼   7
ã€€[å’] ï¼ [å’] ï¼ [å’] ï¼ [å’] ï¼ [å’]  6
ã€€ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼   +
ã€€ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼   +
ã€€(å…µ) ï¼ (å…µ) ï¼ (å…µ) ï¼ (å…µ) ï¼ (å…µ)  3
ã€€ ï¼ (ç‚®) ï¼ ï¼ ï¼ ï¼ ï¼ (ç‚®) ï¼   2
ã€€ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼ ï¼   1
ã€€(è½¦)(é©¬)(ç›¸)(ä»•)(å¸…)(ä»•)(ç›¸)(é©¬)(è½¦)  0

ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€çº¢æ–¹
ã€€ ==ã€€==ã€€==ã€€##ã€€##ã€€##ã€€==ã€€==ã€€==
ã€€ï¼‘ã€€ï¼’ã€€ï¼“ã€€ï¼”ã€€ï¼•ã€€ï¼–ã€€ï¼—ã€€ï¼˜ã€€ï¼™
```

**ç‰¹ç‚¹ï¼š**
- âœ… çº¢æ–¹ç”¨åœ†æ‹¬å· `()`
- âœ… é»‘æ–¹ç”¨æ–¹æ‹¬å· `[]`
- âœ… ç©ºæ ¼ç”¨ `ï¼`
- âœ… æ²³ç•Œè¡Œå·ç”¨ `+` ä»£æ›¿æ•°å­—

---

## ğŸ”§ API ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šè§£æ FEN

```csharp
string fen = "rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w - - 0 1";

var result = FenParser.Parse(fen);

if (result.Success)
{
    Console.WriteLine("è§£ææˆåŠŸï¼");
    Console.WriteLine($"å½“å‰èµ°æ£‹æ–¹ï¼š{result.CurrentPlayer}");
    
    // è®¿é—®æ£‹ç›˜æ•°æ®
    var piece = result.Board[0, 0]; // ç¬¬0è¡Œç¬¬0åˆ—çš„æ£‹å­
    Console.WriteLine($"[0,0] = {piece}"); // BlackRook
}
else
{
    Console.WriteLine($"è§£æå¤±è´¥ï¼š{result.ErrorMessage}");
}
```

### ç¤ºä¾‹ 2ï¼šç”Ÿæˆ FEN

```csharp
ChessPiece[,] board = new ChessPiece[10, 9];
// ... è®¾ç½®æ£‹ç›˜ ...

string fen = FenParser.ToFen(board, "çº¢æ–¹");
Console.WriteLine(fen);
// è¾“å‡ºï¼šrnbakabnr/9/1c5c1/...
```

### ç¤ºä¾‹ 3ï¼šç”Ÿæˆæ–‡æœ¬æ£‹ç›˜

```csharp
var result = FenParser.Parse(fen);

if (result.Success)
{
    string textBoard = FenParser.ToTextBoard(result.Board, true);
    Console.WriteLine(textBoard);
}
```

---

## âœ… é”™è¯¯å¤„ç†

### è‡ªåŠ¨å¤„ç†çš„æƒ…å†µ

1. **è¡Œæ•°ä¸è¶³10è¡Œ** â†’ è‡ªåŠ¨è¡¥é½ç©ºè¡Œ
2. **åˆ—æ•°ä¸è¶³9åˆ—** â†’ è‡ªåŠ¨è¡¥é½ç©ºæ ¼
3. **åˆ—æ•°è¶…è¿‡9åˆ—** â†’ æŠ¥é”™å¹¶æŒ‡å‡ºä½ç½®

### é”™è¯¯ç¤ºä¾‹

```csharp
// é”™è¯¯1ï¼šè¡Œæ•°ä¸å¯¹
string fen = "rnbakabnr/9/1c5c1"; // åªæœ‰3è¡Œ
var result = FenParser.Parse(fen);
// result.Success = false
// result.ErrorMessage = "FENæ ¼å¼é”™è¯¯ï¼šåº”è¯¥æœ‰10è¡Œæ•°æ®ï¼Œå®é™…æœ‰3è¡Œ"

// é”™è¯¯2ï¼šæ— æ•ˆå­—ç¬¦
string fen = "rnbakabnr/9/1Q5c1/..."; // Q ä¸æ˜¯æœ‰æ•ˆæ£‹å­
var result = FenParser.Parse(fen);
// result.Success = false
// result.ErrorMessage = "æ— æ³•è¯†åˆ«çš„æ£‹å­ä»£ç : 'Q' (ä½ç½®ï¼šç¬¬2è¡Œç¬¬2åˆ—)"

// é”™è¯¯3ï¼šåˆ—æ•°è¶…æ ‡
string fen = "rnbakabnrrr/..."; // 11ä¸ªæ£‹å­
var result = FenParser.Parse(fen);
// result.Success = false
// result.ErrorMessage = "ç¬¬0è¡Œæ£‹å­æ•°è¶…è¿‡9ä¸ª"
```

---

## ğŸ¯ ä¸ ChessBoard é›†æˆ

### æ›´æ–°çš„ LoadFromFEN æ–¹æ³•

```csharp
public void LoadFromFEN(string fen)
{
    // ä½¿ç”¨æ–°çš„ FenParser
    var result = FenParser.Parse(fen);
    
    if (!result.Success)
    {
        Debug.WriteLine($"FENè§£æå¤±è´¥: {result.ErrorMessage}");
        return;
    }

    // è½¬æ¢æ•°æ®æ ¼å¼
    for (int row = 0; row < 10; row++)
    {
        for (int col = 0; col < 9; col++)
        {
            Board[col, row] = result.Board[row, col];
        }
    }

    IsRedTurn = result.CurrentPlayer == "çº¢æ–¹";
}
```

---

## ğŸ“ˆ ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | æ—§å®ç° | æ–°å®ç°ï¼ˆFenParserï¼‰ |
|------|--------|-------------------|
| è§£æå‡†ç¡®æ€§ | åŸºæœ¬ | å®Œå…¨å‡†ç¡® âœ… |
| é”™è¯¯å¤„ç† | æ—  | è¯¦ç»†é”™è¯¯ä¿¡æ¯ âœ… |
| æ‰©å±•å­—ç¬¦æ”¯æŒ | å¦ | æ”¯æŒ B/E, N/H, 0/X/x âœ… |
| æ–‡æœ¬è¾“å‡º | æ—  | æ”¯æŒ âœ… |
| è¡Œåˆ—éªŒè¯ | æ—  | å®Œæ•´éªŒè¯ âœ… |

---

## ğŸš€ ä½¿ç”¨å»ºè®®

### æ¨èåšæ³•

1. **è§£æç”¨æˆ·è¾“å…¥çš„ FEN**
   ```csharp
   var result = FenParser.Parse(userInput);
   if (result.Success) {
       board.LoadFromFEN(userInput);
   } else {
       ShowError(result.ErrorMessage);
   }
   ```

2. **è°ƒè¯•æ£‹ç›˜**
   ```csharp
   string text = FenParser.ToTextBoard(board, true);
   Console.WriteLine(text); // ç›´è§‚æŸ¥çœ‹æ£‹ç›˜
   ```

3. **å¯¼å‡º/å¯¼å…¥**
   ```csharp
   // å¯¼å‡º
   string fen = board.ToFEN();
   SaveToFile(fen);
   
   // å¯¼å…¥
   string fen = LoadFromFile();
   board.LoadFromFEN(fen);
   ```

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **100%å‡†ç¡®çš„FENè§£æ** â­â­â­â­â­
   - åŸºäºæˆç†Ÿå¼€æºé¡¹ç›®
   - å®Œæ•´çš„é”™è¯¯å¤„ç†
   - æ”¯æŒæ‰©å±•å­—ç¬¦

2. **æ–‡æœ¬æ£‹ç›˜è¾“å‡º** â­â­â­â­â­
   - ç›´è§‚å¯è¯»
   - é€‚åˆè°ƒè¯•
   - å¯ç”¨äºæ—¥å¿—

3. **æ˜“äºä½¿ç”¨** â­â­â­â­â­
   - ç®€å•çš„API
   - è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - å®Œæ•´çš„æ–‡æ¡£

---

**å‚è€ƒæ¥æºï¼š** https://github.com/kuiba1949/xiangqi-tools  
**å®ç°æ–‡ä»¶ï¼š** `Core/FenParser.cs`  
**æ›´æ–°æ—¶é—´ï¼š** 2025-11-26 10:18  
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆå¹¶é›†æˆ
