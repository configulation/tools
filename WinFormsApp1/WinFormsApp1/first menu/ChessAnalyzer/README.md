# 象棋实时分析助手

## 功能简介

这是一个基于 Pikafish 引擎的象棋实时分析工具，可以帮助用户在下棋时获得 AI 推荐的走法和对方应对策略。

### 主要功能

1. **实时棋盘识别**：支持屏幕区域截图识别当前棋局
2. **引擎分析**：使用 Pikafish 强大的 AI 引擎分析局面
3. **悬浮窗显示**：独立的悬浮窗口显示当前棋局和推荐走法
4. **手动测试**：支持手动输入 FEN 格式测试局面
5. **实时更新**：自动扫描并更新分析结果

## 文件结构

```
ChessAnalyzer/
├── Core/                           # 核心功能模块
│   ├── PikafishEngine.cs          # Pikafish 引擎通信类
│   ├── ChessBoard.cs              # 象棋棋盘管理类
│   └── MoveConverter.cs           # 走法转换工具类
├── UI/                            # 界面模块
│   └── OverlayForm.cs             # 悬浮窗口界面
├── Utils/                         # 工具类
│   └── ScreenCapture.cs           # 屏幕截图工具
├── FrmChessAnalyzer.cs            # 主窗口（逻辑）
├── FrmChessAnalyzer.Designer.cs   # 主窗口（设计器）
└── README.md                      # 本文档
```

## 使用说明

### 1. 启动程序

从主菜单进入 **工具页面 → 象棋实时分析**

### 2. 引擎初始化

程序启动时会自动加载 Pikafish 引擎：
- 引擎路径：`engine/Pikafish.2025-10-27/Windows/pikafish-avx2.exe`
- NNUE 文件：`engine/Pikafish.2025-10-27/pikafish.nnue`
- 状态显示：界面顶部会显示引擎状态（绿色表示就绪）

### 3. 实时分析模式

#### 步骤 1：选择棋盘区域
1. 点击 **选择棋盘区域** 按钮
2. 屏幕会变暗并出现十字光标
3. 按住鼠标左键拖动框选棋盘区域
4. 松开鼠标完成选择（按 ESC 取消）

#### 步骤 2：开始分析
1. 点击 **开始分析** 按钮
2. 悬浮窗口会自动出现
3. 程序每 2 秒自动扫描一次棋盘
4. 分析结果实时更新到悬浮窗口

#### 步骤 3：查看结果
悬浮窗口显示内容：
- **当前棋盘**：9x10 象棋棋盘图形化显示
- **轮次显示**：红方/黑方走棋提示
- **评分信息**：局面评分（正值对红方有利，负值对黑方有利）
- **推荐走法**：当前走棋方的最佳走法（绿色显示）
- **应对走法**：对方的最佳应对（蓝色显示）

### 4. 手动测试模式

#### 使用 FEN 字符串
1. 在 **手动测试** 区域的文本框中输入 FEN 字符串
2. 点击 **分析FEN** 按钮
3. 引擎会立即分析该局面

#### 测试标准开局
1. 点击 **测试局面** 按钮
2. 自动加载标准开局并显示悬浮窗口

### 5. 悬浮窗操作

- **拖动**：按住标题栏可拖动窗口位置
- **最小化**：点击 "−" 按钮最小化窗口
- **关闭**：点击 "✕" 按钮隐藏窗口
- **显示/隐藏**：通过主窗口的 **显示悬浮窗** 按钮控制

## 参数设置

### 搜索深度
- 位置：分析结果面板顶部
- 范围：10 - 30
- 推荐值：18（平衡速度和准确度）
- 说明：深度越大，分析越准确，但耗时越长

### 扫描间隔
- 默认：2000 毫秒（2秒）
- 修改方法：编辑 `FrmChessAnalyzer.cs` 中的 `_scanTimer.Interval` 值

## FEN 格式说明

FEN（Forsyth-Edwards Notation）是象棋局面的标准表示格式。

### 格式示例
```
rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w - - 0 1
```

### 格式说明
1. **棋盘部分**：从黑方（上方）到红方（下方），用 `/` 分隔每一行
   - 大写字母 = 红方棋子：K=帅, A=仕, B=相, N=马, R=车, C=炮, P=兵
   - 小写字母 = 黑方棋子：k=将, a=士, b=象, n=马, r=车, c=炮, p=卒
   - 数字 = 连续空格数

2. **走棋方**：`w` = 红方走棋，`b` = 黑方走棋

3. **其他信息**：半回合计数、回合数等

## ICCS 走法格式

引擎返回的走法使用 ICCS（International Chinese Chess System）格式。

### 格式说明
- 格式：`[起点列][起点行][终点列][终点行]`
- 列：用 a-i 表示（0-8列）
- 行：用 0-9 表示（0-9行）

### 示例
- `h2e2`：第7列第2行的棋子移动到第4列第2行
- `b0c2`：马二进三

## 技术说明

### 引擎版本选择
程序会按以下优先级自动选择引擎：
1. `pikafish-avx2.exe`（推荐，支持 AVX2 指令集）
2. `pikafish-bmi2.exe`（需要 BMI2 指令集）
3. `pikafish-sse41-popcnt.exe`（兼容性最好）

### 引擎配置
- 线程数：4
- 哈希表：256 MB
- NNUE 评估：启用

### 性能建议
1. 使用支持 AVX2 的较新 CPU
2. 增加哈希表大小（需修改代码）
3. 减少扫描频率以降低 CPU 占用

## 常见问题

### Q1: 引擎启动失败
**原因：** 引擎文件不存在或路径错误

**解决：**
1. 检查 `engine/Pikafish.2025-10-27/Windows/` 目录是否存在
2. 确认至少有一个 `.exe` 引擎文件
3. 检查 `pikafish.nnue` 文件是否存在

### Q2: 悬浮窗显示空白
**原因：** 未加载棋局数据

**解决：**
1. 点击 **测试局面** 按钮加载测试棋局
2. 或手动输入 FEN 后点击分析

### Q3: 分析速度很慢
**原因：** 搜索深度过大或 CPU 性能不足

**解决：**
1. 降低搜索深度到 12-15
2. 检查 CPU 占用情况
3. 关闭其他占用资源的程序

### Q4: 选择区域后识别不准确
**原因：** 棋盘皮肤不同或光线问题

**解决：**
1. 选择清晰的棋盘区域
2. 确保棋盘完整显示
3. 暂时使用手动 FEN 输入测试
4. 未来可添加棋子模板提高准确度

## 图像识别功能

### 已实现功能 ✅
- **基础识别**：使用 OpenCvSharp4 实现棋盘识别
- **颜色识别**：基于颜色判断红黑棋子
- **网格检测**：自动检测棋盘 9x10 网格
- **实时转换**：截图自动转换为 FEN 格式

### 使用的库
- **OpenCvSharp4** - OpenCV 的 .NET 封装
- 需要安装 NuGet 包（见安装说明）

### 识别准确度
当前版本使用简化的颜色识别算法：
- 适用场景：清晰的棋盘，良好的光线
- 准确率：约 70-80%（取决于棋盘皮肤）
- 建议：先用手动 FEN 测试引擎功能

## 后续开发计划

### 近期计划
- [ ] 添加棋子模板库（提高准确率到 95%+）
- [ ] 支持多种棋盘皮肤自动识别
- [ ] OCR 文字识别（识别棋子上的汉字）
- [ ] 添加历史记录功能
- [ ] 支持导出对局 PGN

### 远期计划
- [ ] 机器学习棋盘识别
- [ ] 声音提示功能
- [ ] 着法讲解（接入 GPT）
- [ ] 开局库查询
- [ ] 残局库查询

## 依赖项

- **SunnyUI**：界面框架
- **Pikafish**：象棋引擎
- **.NET 6.0+**：运行时环境

## 版权说明

- 本项目使用 Pikafish 引擎，遵循 GPL-3.0 许可证
- Pikafish 项目地址：https://github.com/official-pikafish/Pikafish
- NNUE 神经网络数据来自 Pika Xiangqi Zero 项目

## 联系方式

如有问题或建议，请在项目中提出 Issue。

---

**开发日期：** 2025-11-25  
**版本：** 1.0.0  
**作者：** AI Assistant
